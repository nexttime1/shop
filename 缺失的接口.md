```
# houduan.md
## 1. 品牌模块 /g/v1/brands/:id GET
### 1.1 Protobuf（proto/brand.proto）
syntax = "proto3";
package proto;
option go_package = "./proto;proto";
import "google/protobuf/empty.proto";

message BrandRequest {
  int32 id = 1;
}

message BrandResponse {
  int32 id = 1;
  string name = 2;
  string logo = 3;
  string desc = 4;
}

service BrandService {
  rpc GetBrand(BrandRequest) returns (BrandResponse);
}

### 1.2 Service 层（internal/service/brand.go）
package service

import (
  "context"
  "github.com/opentracing/opentracing-go"
  "go.uber.org/zap"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  "mall/internal/global"
  "mall/internal/model"
  "mall/proto"
)

type BrandServer struct {
  proto.UnimplementedBrandServiceServer
}

func (s *BrandServer) GetBrand(ctx context.Context, req *proto.BrandRequest) (*proto.BrandResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "BrandServer.GetBrand")
  defer span.Finish()

  var brand model.Brand
  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).First(&brand).Error; err != nil {
    zap.S().Errorw("brand not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "brand not found")
  }

  return &proto.BrandResponse{
    Id:   int32(brand.ID),
    Name: brand.Name,
    Logo: brand.Logo,
    Desc: brand.Desc,
  }, nil
}

### 1.3 Web 层（api/good/brand.go）
package good

import (
  "context"
  "strconv"
  "github.com/gin-gonic/gin"
  "github.com/opentracing/opentracing-go"
  "google.golang.org/grpc"
  "google.golang.org/grpc/credentials/insecure"
  "mall/internal/global"
  "mall/internal/res"
  "mall/proto"
)

func BrandDetailView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "BrandDetailView")
  defer span.Finish()

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.GoodsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewBrandServiceClient(conn)
  resp, err := client.GetBrand(ctx, &proto.BrandRequest{Id: int32(id)})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithData(c, resp)
}

// 路由注册（router/good.go）
func InitBrandRouter(r *gin.RouterGroup) {
  g := r.Group("/g/v1")
  g.GET("/brands/:id", BrandDetailView)
}

## 2. 品牌分类模块 /g/v1/categorybrands/:id GET
### 2.1 Protobuf（proto/category_brand.proto）
syntax = "proto3";
package proto;
option go_package = "./proto;proto";
import "google/protobuf/empty.proto";

message CategoryBrandRequest {
  int32 id = 1;
}

message BrandBrief {
  int32 id = 1;
  string name = 2;
  string logo = 3;
}

message CategoryBrief {
  int32 id = 1;
  string name = 2;
  int32 parent_category_id = 3;
  int32 level = 4;
}

message CategoryBrandResponse {
  int32 id = 1;
  BrandBrief brand = 2;
  CategoryBrief category = 3;
}

service CategoryBrandService {
  rpc GetCategoryBrand(CategoryBrandRequest) returns (CategoryBrandResponse);
}

### 2.2 Service 层（internal/service/category_brand.go）
package service

import (
  "context"
  "github.com/opentracing/opentracing-go"
  "go.uber.org/zap"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  "mall/internal/global"
  "mall/internal/model"
  "mall/proto"
)

type CategoryBrandServer struct {
  proto.UnimplementedCategoryBrandServiceServer
}

func (s *CategoryBrandServer) GetCategoryBrand(ctx context.Context, req *proto.CategoryBrandRequest) (*proto.CategoryBrandResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "CategoryBrandServer.GetCategoryBrand")
  defer span.Finish()

  var cb model.CategoryBrand
  if err := global.DB.WithContext(ctx).
    Preload("Brand").
    Preload("Category").
    Where("id = ?", req.Id).
    First(&cb).Error; err != nil {
    zap.S().Errorw("category brand not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "category brand not found")
  }

  return &proto.CategoryBrandResponse{
    Id: int32(cb.ID),
    Brand: &proto.BrandBrief{
      Id:   int32(cb.BrandID),
      Name: cb.Brand.Name,
      Logo: cb.Brand.Logo,
    },
    Category: &proto.CategoryBrief{
      Id:               int32(cb.CategoryID),
      Name:             cb.Category.Name,
      ParentCategoryId: int32(cb.Category.ParentCategoryID),
      Level:            int32(cb.Category.Level),
    },
  }, nil
}

### 2.3 Web 层（api/good/category_brand.go）
package good

import (
  "context"
  "strconv"
  "github.com/gin-gonic/gin"
  "github.com/opentracing/opentracing-go"
  "google.golang.org/grpc"
  "google.golang.org/grpc/credentials/insecure"
  "mall/internal/global"
  "mall/internal/res"
  "mall/proto"
)

func CategoryBrandDetailView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "CategoryBrandDetailView")
  defer span.Finish()

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.GoodsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewCategoryBrandServiceClient(conn)
  resp, err := client.GetCategoryBrand(ctx, &proto.CategoryBrandRequest{Id: int32(id)})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithData(c, resp)
}

// 路由注册
func InitCategoryBrandRouter(r *gin.RouterGroup) {
  g := r.Group("/g/v1")
  g.GET("/categorybrands/:id", CategoryBrandDetailView)
}

## 3. 权限模块 ums（GET/POST/PUT/DELETE /ums/role）
### 3.1 Protobuf（proto/ums.proto）
syntax = "proto3";
package proto;
option go_package = "./proto;proto";
import "google/protobuf/empty.proto";

message RoleItem {
  int32 id = 1;
  string role_name = 2;
  repeated int32 menu_ids = 3;
}

message RoleRequest {
  int32 id = 1;
}

message RoleListRequest {
  int32 page = 1;
  int32 limit = 2;
  string key = 3;
}

message RoleListResponse {
  repeated RoleItem list = 1;
  int32 count = 2;
}

service UmsService {
  rpc GetRole(RoleRequest) returns (RoleItem);
  rpc ListRole(RoleListRequest) returns (RoleListResponse);
  rpc CreateRole(RoleItem) returns (google.protobuf.Empty);
  rpc UpdateRole(RoleItem) returns (google.protobuf.Empty);
  rpc DeleteRole(RoleRequest) returns (google.protobuf.Empty);
}

### 3.2 Service 层（internal/service/ums.go）
package service

import (
  "context"
  "github.com/opentracing/opentracing-go"
  "go.uber.org/zap"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  "mall/internal/global"
  "mall/internal/model"
  "mall/proto"
)

type UmsServer struct {
  proto.UnimplementedUmsServiceServer
}

func (s *UmsServer) GetRole(ctx context.Context, req *proto.RoleRequest) (*proto.RoleItem, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "UmsServer.GetRole")
  defer span.Finish()

  var role model.Role
  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).First(&role).Error; err != nil {
    zap.S().Errorw("role not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "role not found")
  }

  return &proto.RoleItem{
    Id:       int32(role.ID),
    RoleName: role.RoleName,
    MenuIds:  role.MenuIDs,
  }, nil
}

func (s *UmsServer) ListRole(ctx context.Context, req *proto.RoleListRequest) (*proto.RoleListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "UmsServer.ListRole")
  defer span.Finish()

  var roles []model.Role
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.Role{})
  if req.Key != "" {
    db = db.Where("role_name LIKE ?", "%"+req.Key+"%")
  }
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&roles).Error; err != nil {
    zap.S().Errorw("list role error", "err", err)
    return nil, status.Errorf(codes.Internal, "list role error")
  }

  resp := &proto.RoleListResponse{Count: int32(total)}
  for _, r := range roles {
    resp.List = append(resp.List, &proto.RoleItem{
      Id:       int32(r.ID),
      RoleName: r.RoleName,
      MenuIds:  r.MenuIDs,
    })
  }
  return resp, nil
}

func (s *UmsServer) CreateRole(ctx context.Context, req *proto.RoleItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "UmsServer.CreateRole")
  defer span.Finish()

  role := model.Role{
    RoleName: req.RoleName,
    MenuIDs:  req.MenuIds,
  }
  if err := global.DB.WithContext(ctx).Create(&role).Error; err != nil {
    zap.S().Errorw("create role error", "err", err)
    return nil, status.Errorf(codes.Internal, "create role error")
  }
  return &proto.Empty{}, nil
}

func (s *UmsServer) UpdateRole(ctx context.Context, req *proto.RoleItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "UmsServer.UpdateRole")
  defer span.Finish()

  updates := map[string]interface{}{
    "role_name": req.RoleName,
    "menu_ids":  req.MenuIds,
  }
  if err := global.DB.WithContext(ctx).Model(&model.Role{}).Where("id = ?", req.Id).Updates(updates).Error; err != nil {
    zap.S().Errorw("update role error", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.Internal, "update role error")
  }
  return &proto.Empty{}, nil
}

func (s *UmsServer) DeleteRole(ctx context.Context, req *proto.RoleRequest) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "UmsServer.DeleteRole")
  defer span.Finish()

  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).Delete(&model.Role{}).Error; err != nil {
    zap.S().Errorw("delete role error", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.Internal, "delete role error")
  }
  return &proto.Empty{}, nil
}

### 3.3 Web 层（api/ums/role.go）
package ums

import (
  "context"
  "strconv"
  "github.com/gin-gonic/gin"
  "github.com/opentracing/opentracing-go"
  "google.golang.org/grpc"
  "google.golang.org/grpc/credentials/insecure"
  "mall/internal/global"
  "mall/internal/res"
  "mall/proto"
)

func RoleDetailView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "RoleDetailView")
  defer span.Finish()

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.UmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewUmsServiceClient(conn)
  resp, err := client.GetRole(ctx, &proto.RoleRequest{Id: int32(id)})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithData(c, resp)
}

func RoleListView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "RoleListView")
  defer span.Finish()

  page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
  limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))
  key := c.DefaultQuery("key", "")

  conn, err := grpc.Dial(global.Config.UmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewUmsServiceClient(conn)
  resp, err := client.ListRole(ctx, &proto.RoleListRequest{Page: int32(page), Limit: int32(limit), Key: key})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithList(c, resp.List, int(resp.Count))
}

func RoleCreateView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "RoleCreateView")
  defer span.Finish()

  var req proto.RoleItem
  if err := c.ShouldBindJSON(&req); err != nil {
    res.FailWithMsg(c, res.FailArgumentCode, "参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.UmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewUmsServiceClient(conn)
  if _, err := client.CreateRole(ctx, &req); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "创建成功")
}

func RoleUpdateView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "RoleUpdateView")
  defer span.Finish()

  var req proto.RoleItem
  if err := c.ShouldBindJSON(&req); err != nil {
    res.FailWithMsg(c, res.FailArgumentCode, "参数错误")
    return
  }

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }
  req.Id = int32(id)

  conn, err := grpc.Dial(global.Config.UmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewUmsServiceClient(conn)
  if _, err := client.UpdateRole(ctx, &req); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "更新成功")
}

func RoleDeleteView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "RoleDeleteView")
  defer span.Finish()

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.UmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewUmsServiceClient(conn)
  if _, err := client.DeleteRole(ctx, &proto.RoleRequest{Id: int32(id)}); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "删除成功")
}

// 路由注册（router/ums.go）
func InitUmsRouter(r *gin.RouterGroup) {
  g := r.Group("/ums/v1")
  g.GET("/roles", RoleListView)
  g.GET("/roles/:id", RoleDetailView)
  g.POST("/roles", RoleCreateView)
  g.PUT("/roles/:id", RoleUpdateView)
  g.DELETE("/roles/:id", RoleDeleteView)
}

## 4. 营销模块 sms（优惠券/秒杀/广告，示例：优惠券 GET/POST，秒杀 GET/POST，广告 GET/POST）
### 4.1 Protobuf（proto/sms.proto）
syntax = "proto3";
package proto;
option go_package = "./proto;proto";
import "google/protobuf/empty.proto";

message CouponRequest {
  int32 id = 1;
}

message CouponItem {
  int32 id = 1;
  string coupon_code = 2;
  string title = 3;
  int32 discount = 4;
}

message CouponListRequest {
  int32 page = 1;
  int32 limit = 2;
}

message CouponListResponse {
  repeated CouponItem list = 1;
  int32 count = 2;
}

message FlashItem {
  int32 id = 1;
  string name = 2;
  int32 flash_id = 3;
}

message AdItem {
  int32 id = 1;
  string image = 2;
  string url = 3;
}

service SmsService {
  rpc GetCoupon(CouponRequest) returns (CouponItem);
  rpc ListCoupon(CouponListRequest) returns (CouponListResponse);
  rpc CreateCoupon(CouponItem) returns (google.protobuf.Empty);
  rpc GetFlash(CouponRequest) returns (FlashItem);
  rpc ListFlash(CouponListRequest) returns (CouponListResponse); // 复用分页
  rpc CreateFlash(FlashItem) returns (google.protobuf.Empty);
  rpc GetAd(CouponRequest) returns (AdItem);
  rpc ListAd(CouponListRequest) returns (CouponListResponse);
  rpc CreateAd(AdItem) returns (google.protobuf.Empty);
}

### 4.2 Service 层（internal/service/sms.go）
package service

import (
  "context"
  "github.com/opentracing/opentracing-go"
  "go.uber.org/zap"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  "mall/internal/global"
  "mall/internal/model"
  "mall/proto"
)

type SmsServer struct {
  proto.UnimplementedSmsServiceServer
}

// Coupon
func (s *SmsServer) GetCoupon(ctx context.Context, req *proto.CouponRequest) (*proto.CouponItem, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.GetCoupon")
  defer span.Finish()

  var c model.Coupon
  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).First(&c).Error; err != nil {
    zap.S().Errorw("coupon not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "coupon not found")
  }

  return &proto.CouponItem{
    Id:          int32(c.ID),
    CouponCode:  c.CouponCode,
    Title:       c.Title,
    Discount:    int32(c.Discount),
  }, nil
}

func (s *SmsServer) ListCoupon(ctx context.Context, req *proto.CouponListRequest) (*proto.CouponListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.ListCoupon")
  defer span.Finish()

  var list []model.Coupon
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.Coupon{})
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&list).Error; err != nil {
    zap.S().Errorw("list coupon error", "err", err)
    return nil, status.Errorf(codes.Internal, "list coupon error")
  }

  resp := &proto.CouponListResponse{Count: int32(total)}
  for _, v := range list {
    resp.List = append(resp.List, &proto.CouponItem{
      Id:         int32(v.ID),
      CouponCode: v.CouponCode,
      Title:      v.Title,
      Discount:   int32(v.Discount),
    })
  }
  return resp, nil
}

func (s *SmsServer) CreateCoupon(ctx context.Context, req *proto.CouponItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.CreateCoupon")
  defer span.Finish()

  c := model.Coupon{
    CouponCode: req.CouponCode,
    Title:      req.Title,
    Discount:   int(req.Discount),
  }
  if err := global.DB.WithContext(ctx).Create(&c).Error; err != nil {
    zap.S().Errorw("create coupon error", "err", err)
    return nil, status.Errorf(codes.Internal, "create coupon error")
  }
  return &proto.Empty{}, nil
}

// Flash
func (s *SmsServer) GetFlash(ctx context.Context, req *proto.CouponRequest) (*proto.FlashItem, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.GetFlash")
  defer span.Finish()

  var f model.Flash
  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).First(&f).Error; err != nil {
    zap.S().Errorw("flash not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "flash not found")
  }

  return &proto.FlashItem{
    Id:      int32(f.ID),
    Name:    f.Name,
    FlashId: int32(f.FlashID),
  }, nil
}

func (s *SmsServer) ListFlash(ctx context.Context, req *proto.CouponListRequest) (*proto.CouponListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.ListFlash")
  defer span.Finish()

  var list []model.Flash
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.Flash{})
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&list).Error; err != nil {
    zap.S().Errorw("list flash error", "err", err)
    return nil, status.Errorf(codes.Internal, "list flash error")
  }

  resp := &proto.CouponListResponse{Count: int32(total)}
  for _, v := range list {
    resp.List = append(resp.List, &proto.CouponItem{
      Id:         int32(v.ID),
      CouponCode: "", // 占位
      Title:      v.Name,
      Discount:   0,
    })
  }
  return resp, nil
}

func (s *SmsServer) CreateFlash(ctx context.Context, req *proto.FlashItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.CreateFlash")
  defer span.Finish()

  f := model.Flash{
    Name:    req.Name,
    FlashID: int(req.FlashId),
  }
  if err := global.DB.WithContext(ctx).Create(&f).Error; err != nil {
    zap.S().Errorw("create flash error", "err", err)
    return nil, status.Errorf(codes.Internal, "create flash error")
  }
  return &proto.Empty{}, nil
}

// Ad
func (s *SmsServer) GetAd(ctx context.Context, req *proto.CouponRequest) (*proto.AdItem, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.GetAd")
  defer span.Finish()

  var ad model.Ad
  if err := global.DB.WithContext(ctx).Where("id = ?", req.Id).First(&ad).Error; err != nil {
    zap.S().Errorw("ad not found", "id", req.Id, "err", err)
    return nil, status.Errorf(codes.NotFound, "ad not found")
  }

  return &proto.AdItem{
    Id:    int32(ad.ID),
    Image: ad.Image,
    Url:   ad.Url,
  }, nil
}

func (s *SmsServer) ListAd(ctx context.Context, req *proto.CouponListRequest) (*proto.CouponListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.ListAd")
  defer span.Finish()

  var list []model.Ad
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.Ad{})
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&list).Error; err != nil {
    zap.S().Errorw("list ad error", "err", err)
    return nil, status.Errorf(codes.Internal, "list ad error")
  }

  resp := &proto.CouponListResponse{Count: int32(total)}
  for _, v := range list {
    resp.List = append(resp.List, &proto.CouponItem{
      Id:         int32(v.ID),
      CouponCode: "",
      Title:      "",
      Discount:   0,
    })
  }
  return resp, nil
}

func (s *SmsServer) CreateAd(ctx context.Context, req *proto.AdItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "SmsServer.CreateAd")
  defer span.Finish()

  ad := model.Ad{
    Image: req.Image,
    Url:   req.Url,
  }
  if err := global.DB.WithContext(ctx).Create(&ad).Error; err != nil {
    zap.S().Errorw("create ad error", "err", err)
    return nil, status.Errorf(codes.Internal, "create ad error")
  }
  return &proto.Empty{}, nil
}

### 4.3 Web 层（api/sms/sms.go）
package sms

import (
  "context"
  "strconv"
  "github.com/gin-gonic/gin"
  "github.com/opentracing/opentracing-go"
  "google.golang.org/grpc"
  "google.golang.org/grpc/credentials/insecure"
  "mall/internal/global"
  "mall/internal/res"
  "mall/proto"
)

// Coupon
func CouponDetailView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "CouponDetailView")
  defer span.Finish()

  idStr := c.Param("id")
  id, err := strconv.Atoi(idStr)
  if err != nil || id <= 0 {
    res.FailWithMsg(c, res.FailArgumentCode, "id 参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.SmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewSmsServiceClient(conn)
  resp, err := client.GetCoupon(ctx, &proto.CouponRequest{Id: int32(id)})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithData(c, resp)
}

func CouponListView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "CouponListView")
  defer span.Finish()

  page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
  limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))

  conn, err := grpc.Dial(global.Config.SmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewSmsServiceClient(conn)
  resp, err := client.ListCoupon(ctx, &proto.CouponListRequest{Page: int32(page), Limit: int32(limit)})
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithList(c, resp.List, int(resp.Count))
}

func CouponCreateView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "CouponCreateView")
  defer span.Finish()

  var req proto.CouponItem
  if err := c.ShouldBindJSON(&req); err != nil {
    res.FailWithMsg(c, res.FailArgumentCode, "参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.SmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewSmsServiceClient(conn)
  if _, err := client.CreateCoupon(ctx, &req); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "创建成功")
}

// Flash & Ad 可同样模式（示例省略冗余）
func FlashDetailView(c *gin.Context) { /* 同 CouponDetailView，调用 GetFlash */ }
func FlashListView(c *gin.Context)   { /* 同 CouponListView，调用 ListFlash */ }
func FlashCreateView(c *gin.Context) { /* 同 CouponCreateView，调用 CreateFlash */ }
func AdDetailView(c *gin.Context) { /* 调用 GetAd */ }
func AdListView(c *gin.Context)   { /* 调用 ListAd */ }
func AdCreateView(c *gin.Context) { /* 调用 CreateAd */ }

// 路由注册
func InitSmsRouter(r *gin.RouterGroup) {
  g := r.Group("/sms/v1")
  g.GET("/coupons", CouponListView)
  g.GET("/coupons/:id", CouponDetailView)
  g.POST("/coupons", CouponCreateView)
  g.GET("/flash", FlashListView)
  g.GET("/flash/:id", FlashDetailView)
  g.POST("/flash", FlashCreateView)
  g.GET("/ads", AdListView)
  g.GET("/ads/:id", AdDetailView)
  g.POST("/ads", AdCreateView)
}

## 5. 商品属性 & 库存模块 pms/productAttr, pms/skuStock （GET/POST 示例）
### 5.1 Protobuf（proto/pms.proto）
syntax = "proto3";
package proto;
option go_package = "./proto;proto";
import "google/protobuf/empty.proto";

message ProductAttrItem {
  int32 id = 1;
  string attr_name = 2;
  string attr_value = 3;
}

message ProductAttrListRequest {
  int32 page = 1;
  int32 limit = 2;
  string key = 3;
}

message ProductAttrListResponse {
  repeated ProductAttrItem list = 1;
  int32 count = 2;
}

message SkuStockItem {
  int32 id = 1;
  int32 product_id = 2;
  string sku_code = 3;
  int32 stock = 4;
}

message SkuStockListRequest {
  int32 page = 1;
  int32 limit = 2;
  int32 product_id = 3;
}

message SkuStockListResponse {
  repeated SkuStockItem list = 1;
  int32 count = 2;
}

service PmsService {
  rpc ListProductAttr(ProductAttrListRequest) returns (ProductAttrListResponse);
  rpc CreateProductAttr(ProductAttrItem) returns (google.protobuf.Empty);
  rpc ListSkuStock(SkuStockListRequest) returns (SkuStockListResponse);
  rpc CreateSkuStock(SkuStockItem) returns (google.protobuf.Empty);
}

### 5.2 Service 层（internal/service/pms.go）
package service

import (
  "context"
  "github.com/opentracing/opentracing-go"
  "go.uber.org/zap"
  "google.golang.org/grpc/codes"
  "google.golang.org/grpc/status"
  "mall/internal/global"
  "mall/internal/model"
  "mall/proto"
)

type PmsServer struct {
  proto.UnimplementedPmsServiceServer
}

func (s *PmsServer) ListProductAttr(ctx context.Context, req *proto.ProductAttrListRequest) (*proto.ProductAttrListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "PmsServer.ListProductAttr")
  defer span.Finish()

  var list []model.ProductAttr
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.ProductAttr{})
  if req.Key != "" {
    db = db.Where("attr_name LIKE ?", "%"+req.Key+"%")
  }
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&list).Error; err != nil {
    zap.S().Errorw("list product attr error", "err", err)
    return nil, status.Errorf(codes.Internal, "list product attr error")
  }

  resp := &proto.ProductAttrListResponse{Count: int32(total)}
  for _, v := range list {
    resp.List = append(resp.List, &proto.ProductAttrItem{
      Id:        int32(v.ID),
      AttrName:  v.AttrName,
      AttrValue: v.AttrValue,
    })
  }
  return resp, nil
}

func (s *PmsServer) CreateProductAttr(ctx context.Context, req *proto.ProductAttrItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "PmsServer.CreateProductAttr")
  defer span.Finish()

  pa := model.ProductAttr{
    AttrName:  req.AttrName,
    AttrValue: req.AttrValue,
  }
  if err := global.DB.WithContext(ctx).Create(&pa).Error; err != nil {
    zap.S().Errorw("create product attr error", "err", err)
    return nil, status.Errorf(codes.Internal, "create product attr error")
  }
  return &proto.Empty{}, nil
}

func (s *PmsServer) ListSkuStock(ctx context.Context, req *proto.SkuStockListRequest) (*proto.SkuStockListResponse, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "PmsServer.ListSkuStock")
  defer span.Finish()

  var list []model.SkuStock
  var total int64
  db := global.DB.WithContext(ctx).Model(&model.SkuStock{})
  if req.ProductId > 0 {
    db = db.Where("product_id = ?", req.ProductId)
  }
  db.Count(&total)
  if err := db.Limit(int(req.Limit)).Offset(int((req.Page-1)*req.Limit)).Find(&list).Error; err != nil {
    zap.S().Errorw("list sku stock error", "err", err)
    return nil, status.Errorf(codes.Internal, "list sku stock error")
  }

  resp := &proto.SkuStockListResponse{Count: int32(total)}
  for _, v := range list {
    resp.List = append(resp.List, &proto.SkuStockItem{
      Id:        int32(v.ID),
      ProductId: int32(v.ProductID),
      SkuCode:   v.SkuCode,
      Stock:     int32(v.Stock),
    })
  }
  return resp, nil
}

func (s *PmsServer) CreateSkuStock(ctx context.Context, req *proto.SkuStockItem) (*proto.Empty, error) {
  span, ctx := opentracing.StartSpanFromContext(ctx, "PmsServer.CreateSkuStock")
  defer span.Finish()

  ss := model.SkuStock{
    ProductID: int(req.ProductId),
    SkuCode:   req.SkuCode,
    Stock:     int(req.Stock),
  }
  if err := global.DB.WithContext(ctx).Create(&ss).Error; err != nil {
    zap.S().Errorw("create sku stock error", "err", err)
    return nil, status.Errorf(codes.Internal, "create sku stock error")
  }
  return &proto.Empty{}, nil
}

### 5.3 Web 层（api/pms/pms.go）
package pms

import (
  "context"
  "strconv"
  "github.com/gin-gonic/gin"
  "github.com/opentracing/opentracing-go"
  "google.golang.org/grpc"
  "google.golang.org/grpc/credentials/insecure"
  "mall/internal/global"
  "mall/internal/res"
  "mall/proto"
)

// ProductAttr
func ProductAttrListView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "ProductAttrListView")
  defer span.Finish()

  page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
  limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))
  key := c.DefaultQuery("key", "")

  conn, err := grpc.Dial(global.Config.PmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewPmsServiceClient(conn)
  resp, err := client.ListProductAttr(ctx, &proto.ProductAttrListRequest{
    Page:  int32(page),
    Limit: int32(limit),
    Key:   key,
  })
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithList(c, resp.List, int(resp.Count))
}

func ProductAttrCreateView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "ProductAttrCreateView")
  defer span.Finish()

  var req proto.ProductAttrItem
  if err := c.ShouldBindJSON(&req); err != nil {
    res.FailWithMsg(c, res.FailArgumentCode, "参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.PmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewPmsServiceClient(conn)
  if _, err := client.CreateProductAttr(ctx, &req); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "创建成功")
}

// SkuStock
func SkuStockListView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "SkuStockListView")
  defer span.Finish()

  page, _ := strconv.Atoi(c.DefaultQuery("page", "1"))
  limit, _ := strconv.Atoi(c.DefaultQuery("limit", "10"))
  productID, _ := strconv.Atoi(c.DefaultQuery("product_id", "0"))

  conn, err := grpc.Dial(global.Config.PmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewPmsServiceClient(conn)
  resp, err := client.ListSkuStock(ctx, &proto.SkuStockListRequest{
    Page:      int32(page),
    Limit:     int32(limit),
    ProductId: int32(productID),
  })
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithList(c, resp.List, int(resp.Count))
}

func SkuStockCreateView(c *gin.Context) {
  span, ctx := opentracing.StartSpanFromContext(c.Request.Context(), "SkuStockCreateView")
  defer span.Finish()

  var req proto.SkuStockItem
  if err := c.ShouldBindJSON(&req); err != nil {
    res.FailWithMsg(c, res.FailArgumentCode, "参数错误")
    return
  }

  conn, err := grpc.Dial(global.Config.PmsSrv.Addr, grpc.WithTransportCredentials(insecure.NewCredentials()))
  if err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  defer conn.Close()

  client := proto.NewPmsServiceClient(conn)
  if _, err := client.CreateSkuStock(ctx, &req); err != nil {
    res.FailWithServiceMsg(c, err)
    return
  }
  res.OkWithMessage(c, "创建成功")
}

// 路由注册
func InitPmsRouter(r *gin.RouterGroup) {
  g := r.Group("/pms/v1")
  g.GET("/productAttr", ProductAttrListView)
  g.POST("/productAttr", ProductAttrCreateView)
  g.GET("/skuStock", SkuStockListView)
  g.POST("/skuStock", SkuStockCreateView)
}
```

