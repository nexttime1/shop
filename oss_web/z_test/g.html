<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>七牛云直传测试页面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft YaHei", sans-serif;
        }
        .container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .title {
            text-align: center;
            margin-bottom: 30px;
            color: #333;
        }
        .upload-area {
            margin-bottom: 20px;
        }
        .file-input {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 100%;
        }
        .upload-btn {
            background-color: #1890ff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .upload-btn:disabled {
            background-color: #91d5ff;
            cursor: not-allowed;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #eee;
            border-radius: 4px;
            margin: 10px 0;
            overflow: hidden;
            display: none;
        }
        .progress {
            height: 100%;
            background-color: #1890ff;
            width: 0%;
            transition: width 0.3s ease;
        }
        .log-area {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            min-height: 200px;
            background-color: #f9f9f9;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre-wrap;
        }
        .success {
            color: #52c41a;
        }
        .error {
            color: #f5222d;
        }
        .info {
            color: #1890ff;
        }
        .warning {
            color: #faad14;
        }
    </style>
</head>
<body>
<div class="container">
    <h1 class="title">七牛云直传测试</h1>

    <div class="upload-area">
        <input type="file" class="file-input" id="fileInput" accept="*">
        <button class="upload-btn" id="uploadBtn" disabled>选择文件后上传</button>

        <div class="progress-bar" id="progressBar">
            <div class="progress" id="progress"></div>
        </div>
    </div>

    <div class="log-area" id="logArea">
        日志输出区域...
    </div>
</div>

<script>
    // 配置后端接口地址（请替换为你的实际后端地址）
    const BACKEND_BASE_URL = "http://192.168.163.1:8088";
    const GET_TOKEN_API = `${BACKEND_BASE_URL}/oss/v1/token`;

    // DOM 元素
    const fileInput = document.getElementById("fileInput");
    const uploadBtn = document.getElementById("uploadBtn");
    const progressBar = document.getElementById("progressBar");
    const progress = document.getElementById("progress");
    const logArea = document.getElementById("logArea");

    // 初始化日志
    log("初始化完成，等待选择文件...", "info");

    // 监听文件选择
    fileInput.addEventListener("change", (e) => {
        const file = e.target.files[0];
        if (file) {
            uploadBtn.disabled = false;
            log(`已选择文件：${file.name} (大小：${formatFileSize(file.size)})`, "info");
        } else {
            uploadBtn.disabled = true;
            log("未选择文件", "info");
        }
    });

    // 监听上传按钮点击
    uploadBtn.addEventListener("click", async () => {
        const file = fileInput.files[0];
        if (!file) {
            log("请先选择文件！", "error");
            return;
        }

        try {
            // 1. 获取上传凭证
            log("开始获取七牛云上传凭证...", "info");
            const tokenData = await getUploadToken(file.name);
            log(`获取凭证成功：
- uploadHost: ${tokenData.uploadHost}
- key: ${tokenData.key}
- cdnDomain: ${tokenData.cdnDomain}`, "success");

            // 2. 上传文件到七牛云
            log("开始直传文件到七牛云...", "info");
            progressBar.style.display = "block";
            const uploadResult = await uploadToQiniu(file, tokenData);

            // 3. 展示上传结果（优化 URL 拼接）
            const cdnDomain = tokenData.cdnDomain.trim().replace(/\/$/, ''); // 去除域名末尾斜杠
            const fileKey = tokenData.key.trim().replace(/^\//, ''); // 去除 Key 开头斜杠
            let fileUrl = `${cdnDomain}/${fileKey}`;
            // 强制转换为 HTTPS（七牛云强制 HTTPS 访问）
            fileUrl = fileUrl.replace('http://', 'https://');

            // 七牛云测试域名提示
            const testDomainTips = tokenData.cdnDomain.includes('hb-bkt.clouddn.com')
                ? '\n⚠️ 【重要提示】当前使用七牛云测试域名，存在访问限制，建议替换为：\n   源站域名：https://xtmshop.z1.qiniucdn.com \n   或备案后的自定义域名'
                : '';

            log(`文件上传成功！
- 七牛云返回结果：${JSON.stringify(uploadResult)}
- 文件CDN地址：${fileUrl}
- 可访问地址：<a href="${fileUrl}" target="_blank">${fileUrl}</a>${testDomainTips}`, "success");

        } catch (error) {
            log(`上传失败：${error.message}`, "error");
        } finally {
            // 重置进度条
            progressBar.style.display = "none";
            progress.style.width = "0%";
            // 重置按钮状态
            uploadBtn.disabled = true;
            fileInput.value = "";
        }
    });

    /**
     * 获取七牛云上传凭证
     * @param {string} filename 文件名
     * @returns {Promise<object>} 上传凭证数据
     */
    async function getUploadToken(filename) {
        try {
            const response = await fetch(`${GET_TOKEN_API}?filename=${encodeURIComponent(filename)}`, {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                },
                // credentials: "include", // 本地测试可注释，避免跨域凭证问题
            });

            const result = await response.json();
            console.log("后端返回原始数据：", result); // 调试用：打印后端返回数据
            if (!response.ok || result.code !== 0) { // 后端 SuccessCode = 0，正确判断
                throw new Error(`获取凭证失败：${result.msg || "接口返回错误"}`);
            }
            return result.data;
        } catch (error) {
            throw new Error(`获取上传凭证异常：${error.message}`);
        }
    }

    /**
     * 上传文件到七牛云
     * @param {File} file 要上传的文件
     * @param {object} tokenData 上传凭证数据
     * @returns {Promise<object>} 七牛云返回结果
     */
    async function uploadToQiniu(file, tokenData) {
        return new Promise((resolve, reject) => {
            // 构造FormData（七牛云要求的格式）
            const formData = new FormData();
            formData.append("file", file); // 文件流
            formData.append("token", tokenData.token); // 上传凭证
            formData.append("key", tokenData.key); // 文件存储key

            // 创建XHR对象（用于监听上传进度）
            const xhr = new XMLHttpRequest();
            xhr.open("POST", tokenData.uploadHost);

            // 监听上传进度
            xhr.upload.addEventListener("progress", (e) => {
                if (e.lengthComputable) {
                    const percent = (e.loaded / e.total) * 100;
                    progress.style.width = `${percent}%`;
                    log(`上传进度：${Math.round(percent)}%`, "info");
                }
            });

            // 监听上传完成
            xhr.addEventListener("load", () => {
                if (xhr.status > 200 && xhr.status < 300) {
                    try {
                        // 七牛云返回的是JSON字符串，需要解析
                        const result = JSON.parse(xhr.responseText);
                        if (result.key) {
                            resolve(result);
                        } else {
                            reject(new Error(`七牛云返回异常：${xhr.responseText}`));
                        }
                    } catch (error) {
                        reject(new Error(`解析七牛云返回结果失败：${error.message}`));
                    }
                } else {
                    reject(new Error(`上传失败，HTTP状态码：${xhr.status}，响应：${xhr.responseText}`));
                }
            });

            // 监听上传错误
            xhr.addEventListener("error", () => {
                reject(new Error("网络错误，上传失败"));
            });

            // 监听上传取消
            xhr.addEventListener("abort", () => {
                reject(new Error("上传被取消"));
            });

            // 发送请求
            xhr.send(formData);
        });
    }

    /**
     * 格式化文件大小
     * @param {number} bytes 字节数
     * @returns {string} 格式化后的大小
     */
    function formatFileSize(bytes) {
        if (bytes === 0) return "0 B";
        const k = 1024;
        const sizes = ["B", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return `${(bytes / Math.pow(k, i)).toFixed(2)} ${sizes[i]}`;
    }

    /**
     * 日志输出函数（新增警告类型）
     * @param {string} message 日志内容
     * @param {string} type 类型：info/success/error/warning
     */
    function log(message, type = "info") {
        const timestamp = new Date().toLocaleString();
        let className = "info";
        if (type === "success") className = "success";
        else if (type === "error") className = "error";
        else if (type === "warning") className = "warning";

        const logItem = `[${timestamp}] <span class="${className}">${message}</span>\n`;

        // 清空初始提示
        if (logArea.textContent === "日志输出区域...") {
            logArea.innerHTML = "";
        }

        logArea.innerHTML += logItem;
        // 滚动到日志底部
        logArea.scrollTop = logArea.scrollHeight;
    }
</script>
</body>
</html>